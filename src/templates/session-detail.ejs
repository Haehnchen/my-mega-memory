<div class="h-full min-h-0">
  <div class="grid h-full min-h-0 grid-rows-[auto_1fr] bg-jb-light-bg-secondary/70 dark:bg-jb-dark-bg-secondary/70">
    <%- include('partials/toolbar', { query: typeof query !== 'undefined' ? query : '' }) %>
    <div class="grid min-h-0 grid-cols-[minmax(180px,18%)_minmax(220px,24%)_minmax(0,1fr)]">
    <!-- Projects Column -->
    <%- include('partials/projects-sidebar', { projects, activeProjectUuid: typeof activeProjectUuid !== 'undefined' ? activeProjectUuid : null, query: typeof query !== 'undefined' ? query : '', context: 'sessions' }) %>

    <!-- Sessions Column -->
    <aside class="flex h-full min-h-0 flex-col border-b lg:border-b-0 lg:border-r border-jb-light-border dark:border-jb-dark-border">
      <div class="shrink-0 p-4 border-b border-jb-light-border dark:border-jb-dark-border space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs uppercase tracking-[0.2em] text-jb-light-comment dark:text-jb-dark-comment">Sessions</div>
            <div class="text-base font-semibold"><%= project?.name || 'Unknown project' %></div>
          </div>
          <span class="text-xs px-2 py-1 rounded-full bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary text-jb-light-fg-secondary dark:text-jb-dark-fg-secondary">
            <%= sessions.length %>
          </span>
        </div>
        <form action="/search" method="GET" class="flex">
          <input type="hidden" name="project" value="<%= project?.projectUuid || '' %>" />
          <input
            type="text"
            name="q"
            placeholder="Search sessions..."
            class="flex-1 px-3 py-1.5 text-sm rounded-lg border border-jb-light-border dark:border-jb-dark-border bg-jb-light-bg dark:bg-jb-dark-bg text-jb-light-fg dark:text-jb-dark-fg focus:outline-none focus:ring-2 focus:ring-jb-light-accent dark:focus:ring-jb-dark-accent"
          />
        </form>
      </div>
      <div class="min-h-0 flex-1 overflow-y-auto p-2 pb-1 space-y-2">
        <% if (sessions.length === 0) { %>
          <div class="p-4 text-sm text-jb-light-comment dark:text-jb-dark-comment">No sessions yet.</div>
        <% } else { %>
          <% const activeSession = sessions.find(s => s.sessionId === activeSessionId); %>
          <% const otherSessions = sessions.filter(s => s.sessionId !== activeSessionId); %>
          <% const orderedSessions = activeSession ? [activeSession, ...otherSessions] : sessions; %>
          <% orderedSessions.forEach((s, index) => { %>
            <% const isActive = s.sessionId === activeSessionId; %>
            <a href="/sessions/<%= s.sessionId %>"
               class="group block rounded-xl border <%= isActive ? 'border-jb-light-accent dark:border-jb-dark-accent bg-jb-light-bg-tertiary/70 dark:bg-jb-dark-bg-tertiary/70' : 'border-transparent bg-jb-light-bg dark:bg-jb-dark-bg hover:border-jb-light-accent/60 dark:hover:border-jb-dark-accent/60' %> hover:shadow-sm">
              <div class="p-3 space-y-2">
                <div class="flex items-center gap-2">
                  <div class="flex-shrink-0 provider-icon w-4 h-4 <%= s.provider %>" title="<%= s.provider.replace('_', ' ') %>">
                    <img src="/assets/icons/providers/<%= s.provider %>.svg" alt="<%= s.provider %>">
                  </div>
                  <div class="font-medium truncate <%= isActive ? 'text-jb-light-accent dark:text-jb-dark-accent' : 'group-hover:text-jb-light-accent dark:group-hover:text-jb-dark-accent' %>"><%= s.title %></div>
                </div>
                <div class="flex items-center gap-2 text-xs text-jb-light-comment dark:text-jb-dark-comment">
                  <span class="px-2 py-0.5 rounded-full bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary"><%= s.messageCount %> msgs</span>
                  <span>Updated <%= new Date(s.updatedAt).toLocaleDateString() %></span>
                </div>
              </div>
            </a>
            <% if (index === 0 && activeSession && otherSessions.length > 0) { %>
              <div class="my-2 border-t border-jb-light-border/70 dark:border-jb-dark-border/70"></div>
            <% } %>
          <% }); %>
        <% } %>
      </div>
    </aside>

    <!-- Content Column -->
    <section class="flex h-full min-h-0 flex-col">
      <div class="shrink-0 p-4 border-b border-jb-light-border dark:border-jb-dark-border bg-jb-light-bg/70 dark:bg-jb-dark-bg/70">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div class="min-w-0">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0 provider-icon w-6 h-6 <%= session.provider %>" title="<%= session.provider.replace('_', ' ') %>">
                <img src="/assets/icons/providers/<%= session.provider %>.svg" alt="<%= session.provider %>">
              </div>
              <h1 class="text-xl font-semibold truncate"><%= session.title %></h1>
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <% if (session.version) { %>
              <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary text-jb-light-accent dark:text-jb-dark-accent">
                <%= session.version %>
              </span>
            <% } %>
            <% if (session.gitBranch) { %>
              <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary text-jb-light-fg-secondary dark:text-jb-dark-fg-secondary">
                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                </svg>
                <%= session.gitBranch %>
              </span>
            <% } %>
            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary text-jb-light-fg-secondary dark:text-jb-dark-fg-secondary">
              <%= session.messageCount %> messages
            </span>
          </div>
        </div>
        <div class="mt-2 text-xs text-jb-light-comment dark:text-jb-dark-comment flex flex-wrap gap-1 leading-none">
          <% if (session.sessionId) { %>
            <div><span class="font-semibold text-jb-light-comment dark:text-jb-dark-comment">Session ID:</span> <span class="text-jb-light-comment dark:text-jb-dark-comment"><%= session.sessionId %></span></div>
          <% } %>
          <% if (session.created) { %>
            <div><span class="font-semibold text-jb-light-comment dark:text-jb-dark-comment">Created:</span> <span class="text-jb-light-comment dark:text-jb-dark-comment"><%= new Date(session.created).toLocaleString() %></span></div>
          <% } %>
          <% if (session.modified && session.modified !== session.created) { %>
            <div><span class="font-semibold text-jb-light-comment dark:text-jb-dark-comment">Modified:</span> <span class="text-jb-light-comment dark:text-jb-dark-comment"><%= new Date(session.modified).toLocaleString() %></span></div>
          <% } %>
          <% if (session.models) { %>
            <% if (session.models.length > 0) { %>
              <div><span class="font-semibold text-jb-light-comment dark:text-jb-dark-comment">Models:</span> <span class="text-jb-light-comment dark:text-jb-dark-comment"><%= session.models.slice(0, 3).map(m => m[0]).join(', ') %><%= session.models.length > 3 ? ` +${session.models.length - 3} more` : '' %></span></div>
            <% } %>
          <% } %>
        </div>
      </div>

      <div class="min-h-0 flex-1 overflow-y-auto p-4 pb-2 space-y-4">
        <% messages.forEach((message, index) => { %>
          <div class="message-card <%= message.cardType %>" data-sequence="<%= message.sequence %>">
            <div class="flex items-center justify-between px-4 py-2 bg-black/5 dark:bg-white/5 border-b border-jb-light-border dark:border-jb-dark-border">
              <div class="flex items-center gap-3">
                <span class="type-badge <%= message.cardType %>">
                  <%= message.title %>
                </span>
                <% if (message.subtitle) { %>
                  <span class="text-sm text-jb-light-comment dark:text-jb-dark-comment font-mono">
                    <%= message.subtitle %>
                  </span>
                <% } %>
              </div>
              <span class="text-xs text-jb-light-comment dark:text-jb-dark-comment">
                <%= new Date(message.timestamp).toLocaleTimeString() %>
              </span>
            </div>

            <div class="message-content-wrapper">
              <div class="message-content">
                <div class="space-y-3">
                  <% if (message.content && message.content.length > 0) { %>
                    <% message.content.forEach(block => { %>
                      <% if (block.type === 'text' && block.text) { %>
                        <p class="text-sm whitespace-pre-wrap"><%= block.text %></p>
                      <% } else if (block.type === 'code' && block.code) { %>
                        <div class="relative group">
                          <% if (block.language) { %>
                            <div class="absolute top-2 right-2 text-xs text-jb-light-comment dark:text-jb-dark-comment px-2 py-1 bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary rounded">
                              <%= block.language %>
                            </div>
                          <% } %>
                          <pre class="bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary p-4 rounded-lg overflow-x-auto text-sm font-mono"><code><%= block.code %></code></pre>
                        </div>
                      <% } else if (block.type === 'markdown' && block.markdown) { %>
                        <div class="prose dark:prose-invert prose-sm max-w-none">
                          <%= block.markdown %>
                        </div>
                      <% } else if (block.type === 'json' && block.json) { %>
                        <pre class="bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary p-4 rounded-lg overflow-x-auto text-sm font-mono text-jb-light-fg-secondary dark:text-jb-dark-fg-secondary"><code><%= block.json %></code></pre>
                      <% } else if (block.type === 'html' && block.html) { %>
                        <div class="markdown-content">
                          <%- block.html %>
                        </div>
                      <% } %>
                    <% }); %>
                  <% } else { %>
                    <p class="text-sm text-jb-light-comment dark:text-jb-dark-comment italic">No content</p>
                  <% } %>
                </div>
              </div>
              <div class="expand-bar clickable" onclick="toggleExpand(this)">
                <span class="expand-text">Expand</span>
                <span class="expand-icon">
                  <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="6 9 12 15 18 9"></polyline>
                  </svg>
                </span>
              </div>
            </div>
          </div>
        <% }); %>

        <% if (messages.length === 0) { %>
          <div class="text-center py-16">
            <svg class="w-16 h-16 mx-auto text-jb-light-comment dark:text-jb-dark-comment mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
            <h3 class="text-lg font-medium mb-2">No messages</h3>
            <p class="text-jb-light-comment dark:text-jb-dark-comment">This session has no messages.</p>
          </div>
        <% } %>
      </div>
    </section>
    </div>
  </div>
</div>

<style>
  /* Markdown Content Styles */
  .markdown-content {
    font-size: 14px;
    line-height: 1.6;
  }

  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4,
  .markdown-content h5,
  .markdown-content h6 {
    margin-top: 16px;
    margin-bottom: 8px;
    font-weight: 600;
  }

  .markdown-content h1 { font-size: 1.5em; }
  .markdown-content h2 { font-size: 1.3em; }
  .markdown-content h3 { font-size: 1.1em; }

  .markdown-content p {
    margin-bottom: 12px;
  }

  .markdown-content ul,
  .markdown-content ol {
    margin-bottom: 12px;
    padding-left: 24px;
  }

  .markdown-content li {
    margin-bottom: 4px;
  }

  .markdown-content code {
    font-family: var(--font-mono);
    font-size: 0.9em;
    padding: 2px 6px;
    border-radius: 3px;
    background: var(--bg-tertiary);
  }

  .markdown-content pre {
    background: var(--bg-tertiary);
    padding: 12px;
    border-radius: 6px;
    overflow-x: auto;
    margin-bottom: 12px;
  }

  .markdown-content pre code {
    padding: 0;
    background: transparent;
  }

  .markdown-content blockquote {
    border-left: 4px solid var(--border-color);
    padding-left: 12px;
    margin-left: 0;
    margin-bottom: 12px;
    color: var(--fg-secondary);
  }

  .markdown-content a {
    color: var(--accent-color);
    text-decoration: none;
  }

  .markdown-content a:hover {
    text-decoration: underline;
  }

  .markdown-content table {
    border-collapse: collapse;
    margin-bottom: 12px;
    width: 100%;
  }

  .markdown-content th,
  .markdown-content td {
    border: 1px solid var(--border-color);
    padding: 8px 12px;
    text-align: left;
  }

  .markdown-content th {
    background: var(--bg-tertiary);
    font-weight: 600;
  }

  /* Light theme markdown colors */
  .light .markdown-content code {
    background: #f1f3f4;
    color: #37474f;
  }

  .light .markdown-content pre {
    background: #f8f9fa;
  }

  .light .markdown-content blockquote {
    border-left-color: #dadce0;
    color: #5f6368;
  }

  .light .markdown-content a {
    color: #0066cc;
  }

  .light .markdown-content th,
  .light .markdown-content td {
    border-color: #dadce0;
  }

  .light .markdown-content th {
    background: #f8f9fa;
  }

  /* Dark theme markdown colors */
  .dark .markdown-content code {
    background: #2d2d2d;
    color: #a9b7c6;
  }

  .dark .markdown-content pre {
    background: #2b2b2b;
  }

  .dark .markdown-content blockquote {
    border-left-color: #4a4a4a;
    color: #a0a0a0;
  }

  .dark .markdown-content a {
    color: #589df6;
  }

  .dark .markdown-content th,
  .dark .markdown-content td {
    border-color: #4a4a4a;
  }

  .dark .markdown-content th {
    background: #2d2d2d;
  }

  /* Message Card Styles */
  .message-card {
    border-radius: 8px;
    overflow: hidden;
    border-left: 3px solid transparent;
    background: var(--bg-secondary);
  }

  /* Light theme message colors */
  .light .message-card.user {
    background: #e8f0fe;
    border-left-color: #0066cc;
  }
  .light .message-card.assistant {
    background: #e6f4ea;
    border-left-color: #1e8e3e;
  }
  .light .message-card.thinking {
    background: #f3e8fd;
    border-left-color: #9334e6;
  }
  .light .message-card.tool-use {
    background: #fef3e8;
    border-left-color: #f9ab00;
  }
  .light .message-card.tool-result {
    background: #f8f9fa;
    border-left-color: #6c757d;
  }
  .light .message-card.info {
    background: #f8f9fa;
    border-left-color: #6c757d;
  }
  .light .message-card.error {
    background: #fce8e8;
    border-left-color: #d93025;
  }

  /* Dark theme message colors */
  .dark .message-card.user {
    background: #2d3b55;
    border-left-color: #589df6;
  }
  .dark .message-card.assistant {
    background: #2d4a3e;
    border-left-color: #36a3d6;
  }
  .dark .message-card.thinking {
    background: #3d3455;
    border-left-color: #9876aa;
  }
  .dark .message-card.tool-use {
    background: #4a3d2d;
    border-left-color: #cc7832;
  }
  .dark .message-card.tool-result {
    background: #3c3f41;
    border-left-color: #808080;
  }
  .dark .message-card.info {
    background: #3c3f41;
    border-left-color: #808080;
  }
  .dark .message-card.error {
    background: #4a2d2d;
    border-left-color: #ff6b6b;
  }

  /* Type Badges */
  .type-badge {
    display: inline-flex;
    align-items: center;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .light .type-badge.user {
    background: #0066cc;
    color: white;
  }
  .light .type-badge.assistant {
    background: #1e8e3e;
    color: white;
  }
  .light .type-badge.thinking {
    background: #9334e6;
    color: white;
  }
  .light .type-badge.tool-use {
    background: #f9ab00;
    color: white;
  }
  .light .type-badge.tool-result {
    background: #6c757d;
    color: white;
  }
  .light .type-badge.info {
    background: #6c757d;
    color: white;
  }
  .light .type-badge.error {
    background: #d93025;
    color: white;
  }

  .dark .type-badge.user {
    background: #589df6;
    color: #2b2b2b;
  }
  .dark .type-badge.assistant {
    background: #36a3d6;
    color: #2b2b2b;
  }
  .dark .type-badge.thinking {
    background: #9876aa;
    color: #2b2b2b;
  }
  .dark .type-badge.tool-use {
    background: #cc7832;
    color: #2b2b2b;
  }
  .dark .type-badge.tool-result {
    background: #808080;
    color: #2b2b2b;
  }
  .dark .type-badge.info {
    background: #808080;
    color: #2b2b2b;
  }
  .dark .type-badge.error {
    background: #ff6b6b;
    color: #2b2b2b;
  }

  /* Diff View Styles */
  .diff-view {
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border-color);
    background: var(--bg-tertiary);
    margin: 8px 0;
  }

  .diff-content-wrapper {
    overflow-x: auto;
    font-family: var(--font-mono);
    font-size: 13px;
    line-height: 1.5;
  }

  .diff-line {
    display: flex;
    align-items: stretch;
    white-space: pre;
    min-height: 20px;
  }

  .diff-marker {
    flex-shrink: 0;
    width: 24px;
    text-align: center;
    font-weight: bold;
    user-select: none;
    padding: 1px 0;
  }

  .diff-content {
    flex: 1;
    padding: 1px 8px;
    white-space: pre;
  }

  /* Light theme diff colors */
  .light .diff-removed {
    background: #ffebe9;
  }
  .light .diff-removed .diff-marker {
    background: #ffd7d5;
    color: #cf222e;
  }
  .light .diff-removed .diff-content {
    color: #82071e;
  }

  .light .diff-added {
    background: #e6ffec;
  }
  .light .diff-added .diff-marker {
    background: #ccffd8;
    color: #1a7f37;
  }
  .light .diff-added .diff-content {
    color: #055d20;
  }

  .light .diff-context {
    background: #f6f8fa;
  }
  .light .diff-context .diff-marker {
    background: #eaeef2;
    color: #6e7781;
  }
  .light .diff-context .diff-content {
    color: #24292f;
  }

  /* Dark theme diff colors */
  .dark .diff-removed {
    background: #3d1414;
  }
  .dark .diff-removed .diff-marker {
    background: #4d1a1a;
    color: #ff7b72;
  }
  .dark .diff-removed .diff-content {
    color: #ffbcbc;
  }

  .dark .diff-added {
    background: #122f20;
  }
  .dark .diff-added .diff-marker {
    background: #183d29;
    color: #7ee787;
  }
  .dark .diff-added .diff-content {
    color: #aff5b4;
  }

  .dark .diff-context {
    background: #21262d;
  }
  .dark .diff-context .diff-marker {
    background: #2b3138;
    color: #8b949e;
  }
  .dark .diff-context .diff-content {
    color: #c9d1d9;
  }

  /* Expand/Collapse Styles */
  .message-content-wrapper {
    position: relative;
  }

  .message-content-wrapper .message-content {
    padding: 16px;
  }

  .message-content-wrapper.collapsed .message-content {
    max-height: 200px;
    overflow: hidden;
    position: relative;
  }

  .message-content-wrapper.collapsed .message-content::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60px;
    pointer-events: none;
  }

  .light .message-card.user .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #e8f0fe);
  }
  .light .message-card.assistant .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #e6f4ea);
  }
  .light .message-card.thinking .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #f3e8fd);
  }
  .light .message-card.tool-use .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #fef3e8);
  }
  .light .message-card.tool-result .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #f8f9fa);
  }
  .light .message-card.info .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #f8f9fa);
  }
  .light .message-card.error .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #fce8e8);
  }

  .dark .message-card.user .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #2d3b55);
  }
  .dark .message-card.assistant .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #2d4a3e);
  }
  .dark .message-card.thinking .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #3d3455);
  }
  .dark .message-card.tool-use .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #4a3d2d);
  }
  .dark .message-card.tool-result .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #3c3f41);
  }
  .dark .message-card.info .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #3c3f41);
  }
  .dark .message-card.error .message-content-wrapper.collapsed .message-content::after {
    background: linear-gradient(transparent, #4a2d2d);
  }

  .expand-bar {
    display: none;
    width: 100%;
    padding: 8px 0;
    text-align: center;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    user-select: none;
    border-top: 1px solid var(--border-color);
    transition: none;
  }

  .light .expand-bar {
    background: rgba(0, 0, 0, 0.05);
    color: #0066cc;
  }

  .dark .expand-bar {
    background: rgba(255, 255, 255, 0.05);
    color: #589df6;
  }

  .expand-bar:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  .dark .expand-bar:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  .message-content-wrapper.collapsed .expand-bar,
  .message-content-wrapper.expanded .expand-bar {
    display: block;
  }

  .expand-bar .expand-icon {
    display: inline-block;
    margin-left: 4px;
    transition: none;
  }

  .message-content-wrapper.expanded .expand-bar .expand-icon {
    transform: rotate(180deg);
  }
</style>

<script>
  function toggleExpand(element) {
      const wrapper = element.parentElement;
      const textSpan = element.querySelector('.expand-text');
      if (wrapper.classList.contains('collapsed')) {
          wrapper.classList.remove('collapsed');
          wrapper.classList.add('expanded');
          if (textSpan) textSpan.textContent = 'Collapse';
      } else {
          wrapper.classList.remove('expanded');
          wrapper.classList.add('collapsed');
          if (textSpan) textSpan.textContent = 'Expand';
      }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const wrappers = document.querySelectorAll('.message-content-wrapper');
    wrappers.forEach(function(wrapper) {
      const content = wrapper.querySelector('.message-content');
      if (content && content.scrollHeight > 220) {
        wrapper.classList.add('collapsed');
      }
    });
  });
</script>
