<% const sidebarContext = typeof context !== 'undefined' ? context : 'sessions'; %>
<% const activeProject = projects.find(p => p.projectUuid === activeProjectUuid); %>
<% const otherProjects = projects.filter(p => p.projectUuid !== activeProjectUuid); %>
<% const orderedProjects = activeProject ? [activeProject, ...otherProjects] : projects; %>
<aside class="flex h-full min-h-0 flex-col border-r border-jb-light-border dark:border-jb-dark-border">
  <div class="shrink-0 p-4 border-b border-jb-light-border dark:border-jb-dark-border">
    <div class="flex items-center justify-between">
      <div>
        <div class="text-xs uppercase tracking-[0.2em] text-jb-light-comment dark:text-jb-dark-comment">Projects</div>
        <div class="text-base font-semibold">All workspaces</div>
      </div>
      <span class="text-xs px-2 py-1 rounded-full bg-jb-light-bg-tertiary dark:bg-jb-dark-bg-tertiary text-jb-light-fg-secondary dark:text-jb-dark-fg-secondary">
        <%= projects.length %>
      </span>
    </div>
  </div>
  <div class="min-h-0 flex-1 overflow-y-auto p-2 pb-1 space-y-2">
    <% if (projects.length === 0) { %>
      <div class="p-4 text-sm text-jb-light-comment dark:text-jb-dark-comment">No projects found yet.</div>
    <% } else { %>
      <% orderedProjects.forEach((p, index) => { %>
        <% const isActive = p.projectUuid === activeProjectUuid; %>
        <% const href = sidebarContext === 'search'
          ? `/search?project=${encodeURIComponent(p.projectUuid)}${(typeof query !== 'undefined' && query) ? `&q=${encodeURIComponent(query)}` : ''}`
          : `/sessions/project/${p.projectUuid}`; %>
        <a href="<%= href %>"
           class="group block rounded-xl border <%= isActive ? 'border-jb-light-accent dark:border-jb-dark-accent bg-jb-light-bg-tertiary/70 dark:bg-jb-dark-bg-tertiary/70' : 'border-transparent bg-jb-light-bg dark:bg-jb-dark-bg hover:border-jb-light-accent/60 dark:hover:border-jb-dark-accent/60' %> hover:shadow-sm">
          <div class="p-3 space-y-2">
            <div class="flex items-start justify-between gap-2">
              <div class="min-w-0">
                <div class="font-medium truncate <%= isActive ? 'text-jb-light-accent dark:text-jb-dark-accent' : 'group-hover:text-jb-light-accent dark:group-hover:text-jb-dark-accent' %>"><%= p.name %></div>
                <% if (p.path) { %>
                  <div class="text-xs text-jb-light-comment dark:text-jb-dark-comment font-mono truncate" title="<%= p.path %>">
                    <%= p.path %>
                  </div>
                <% } %>
              </div>
              <div class="text-xs text-jb-light-fg-secondary dark:text-jb-dark-fg-secondary">
                <%= p.sessionCount %>
              </div>
            </div>
            <div class="flex items-center gap-1">
              <% p.providers.forEach(provider => { %>
                <div class="provider-icon w-4 h-4 <%= provider %>" title="<%= provider.replace('_', ' ') %>">
                  <img src="/assets/icons/providers/<%= provider %>.svg" alt="<%= provider %>">
                </div>
              <% }); %>
            </div>
          </div>
        </a>
        <% if (index === 0 && activeProject && otherProjects.length > 0) { %>
          <div class="my-2 border-t border-jb-light-border/70 dark:border-jb-dark-border/70"></div>
        <% } %>
      <% }); %>
    <% } %>
  </div>
</aside>
